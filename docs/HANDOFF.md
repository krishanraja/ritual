# Developer Handoff Guide

This document helps new developers get up to speed on the Ritual codebase.

---

## Quick Start

### Prerequisites
- Node.js 18+ or Bun
- Git
- Code editor (VS Code recommended)

### Local Setup

1. **Clone Repository:**
```bash
git clone <repository-url>
cd ritual
```

2. **Install Dependencies:**
```bash
npm install
# or
bun install
```

3. **Environment Variables:**
The `.env` file is auto-generated by Lovable Cloud. It contains:
```
VITE_SUPABASE_URL=https://ffowyysujkzwxisjckxh.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=...
VITE_SUPABASE_PROJECT_ID=ffowyysujkzwxisjckxh
```

**Never edit `.env` manually.** It's regenerated automatically.

4. **Start Development Server:**
```bash
npm run dev
```

Visit http://localhost:5173

---

## Project Structure

```
ritual/
â”œâ”€â”€ docs/                   # Project documentation (you are here)
â”œâ”€â”€ public/                 # Static assets
â”‚   â”œâ”€â”€ favicon.png         # App icon
â”‚   â”œâ”€â”€ robots.txt          # SEO
â”‚   â””â”€â”€ sitemap.xml         # SEO
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/         # React components
â”‚   â”‚   â”œâ”€â”€ ui/             # shadcn/ui components (DON'T EDIT)
â”‚   â”‚   â”œâ”€â”€ AppShell.tsx    # App layout + navigation
â”‚   â”‚   â”œâ”€â”€ StatusIndicator.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ contexts/           # React contexts
â”‚   â”‚   â””â”€â”€ CoupleContext.tsx   # Global state management
â”‚   â”œâ”€â”€ hooks/              # Custom hooks
â”‚   â”‚   â”œâ”€â”€ use-toast.ts
â”‚   â”‚   â”œâ”€â”€ useMagneticSync.ts
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ integrations/       # External integrations
â”‚   â”‚   â””â”€â”€ supabase/       # Supabase client (DON'T EDIT)
â”‚   â”‚       â”œâ”€â”€ client.ts   # Auto-generated
â”‚   â”‚       â””â”€â”€ types.ts    # Auto-generated from DB schema
â”‚   â”œâ”€â”€ pages/              # Route pages
â”‚   â”‚   â”œâ”€â”€ Landing.tsx
â”‚   â”‚   â”œâ”€â”€ Auth.tsx
â”‚   â”‚   â”œâ”€â”€ Home.tsx
â”‚   â”‚   â”œâ”€â”€ QuickInput.tsx
â”‚   â”‚   â”œâ”€â”€ RitualPicker.tsx
â”‚   â”‚   â”œâ”€â”€ RitualCards.tsx
â”‚   â”‚   â”œâ”€â”€ History.tsx
â”‚   â”‚   â””â”€â”€ Profile.tsx
â”‚   â”œâ”€â”€ utils/              # Utility functions
â”‚   â”‚   â”œâ”€â”€ calendarUtils.ts
â”‚   â”‚   â”œâ”€â”€ shareUtils.ts
â”‚   â”‚   â””â”€â”€ timezoneUtils.ts
â”‚   â”œâ”€â”€ types/              # TypeScript types
â”‚   â”‚   â””â”€â”€ magneticCanvas.ts
â”‚   â”œâ”€â”€ data/               # Static data
â”‚   â”‚   â””â”€â”€ sampleRituals.ts
â”‚   â”œâ”€â”€ App.tsx             # Root component
â”‚   â”œâ”€â”€ main.tsx            # Entry point
â”‚   â””â”€â”€ index.css           # Global styles + design tokens
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/          # Edge functions
â”‚   â”‚   â”œâ”€â”€ synthesize-rituals/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ nudge-partner/
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ migrations/         # Database migrations (DON'T EDIT)
â”‚   â””â”€â”€ config.toml         # Supabase config (DON'T EDIT)
â”œâ”€â”€ tailwind.config.ts      # Tailwind configuration
â”œâ”€â”€ vite.config.ts          # Vite configuration
â””â”€â”€ package.json            # Dependencies
```

---

## Files You Should NEVER Edit

These files are auto-generated by Lovable Cloud:

- `.env`
- `src/integrations/supabase/client.ts`
- `src/integrations/supabase/types.ts`
- `supabase/config.toml`
- `supabase/migrations/*`

Editing these will cause deployment issues or be overwritten.

---

## Common Tasks

### Task 1: Add a New Page

1. **Create Page Component:**
```tsx
// src/pages/NewPage.tsx
import { StrictMobileViewport } from '@/components/StrictMobileViewport';

export default function NewPage() {
  return (
    <StrictMobileViewport>
      <div className="h-full bg-gradient-warm p-4">
        <h1 className="text-2xl font-bold">New Page</h1>
      </div>
    </StrictMobileViewport>
  );
}
```

2. **Add Route:**
```tsx
// src/App.tsx
import { Route, Routes } from 'react-router-dom';
import Landing from './pages/Landing';
import Auth from './pages/Auth';
import Home from './pages/Home';
import QuickInput from './pages/QuickInput';
import RitualPicker from './pages/RitualPicker';
import RitualCards from './pages/RitualCards';
import History from './pages/History';
import Profile from './pages/Profile';
import NewPage from "./pages/NewPage";

function App() {
  return (
    <Routes>
      <Route path="/" element={<Landing />} />
      <Route path="/landing" element={<Landing />} />
      <Route path="/auth" element={<Auth />} />
      <Route path="/home" element={<Home />} />
      <Route path="/input" element={<QuickInput />} />
      <Route path="/picker" element={<RitualPicker />} />
      <Route path="/rituals" element={<RitualCards />} />
      <Route path="/history" element={<History />} />
      <Route path="/profile" element={<Profile />} />
      <Route path="/new" element={<NewPage />} />
    </Routes>
  );
}

export default App;
```

3. **Add Navigation (if needed):**
```tsx
// src/components/AppShell.tsx
import { ReactNode, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Home, Calendar, Clock, User, UserPlus } from 'lucide-react';
import { Button } from './ui/button';
import { useCouple } from '@/contexts/CoupleContext';
import { JoinDrawer } from './JoinDrawer';
import { CreateCoupleDialog } from './CreateCoupleDialog';
import { StatusIndicator } from './StatusIndicator';
import { motion } from 'framer-motion';

interface AppShellProps {
  children: ReactNode;
}

export const AppShell = ({ children }: AppShellProps) => {
  const location = useLocation();
  const navigate = useNavigate();
  const { user, couple, currentCycle } = useCouple();
  const [joinOpen, setJoinOpen] = useState(false);
  const [createOpen, setCreateOpen] = useState(false);
  
  const isAuthPage = location.pathname === '/auth';
  const showNav = user && !isAuthPage;

  const getThisWeekRoute = () => {
    if (!couple || !couple.partner_two) return '/home';
    
    if (!currentCycle) return '/input';
    
    const isPartnerOne = couple.partner_one === user?.id;
    const userSubmitted = isPartnerOne 
      ? currentCycle.partner_one_input 
      : currentCycle.partner_two_input;
    const partnerSubmitted = isPartnerOne
      ? currentCycle.partner_two_input
      : currentCycle.partner_one_input;
    
    // Both submitted and agreed on ritual
    if (currentCycle.agreement_reached && currentCycle.agreed_ritual) {
      return '/rituals';
    }
    
    // Both submitted, has synthesized output but no agreement yet
    if (userSubmitted && partnerSubmitted && currentCycle.synthesized_output) {
      return '/picker';
    }
    
    // User submitted, waiting for partner
    if (userSubmitted) {
      return '/home';
    }
    
    // Neither submitted yet
    return '/input';
  };

  const navItems = [
    { path: '/home', icon: Home, label: 'Home' },
    { path: getThisWeekRoute(), icon: Calendar, label: 'This Week' },
    { path: '/history', icon: Clock, label: 'History' },
    { path: '/profile', icon: User, label: 'Profile' },
    { path: '/new', icon: User, label: 'New' }
  ];

  return (
    <div className="flex flex-col h-screen bg-gradient-warm overflow-hidden">
      {/* Top Bar */}
      {showNav && (
        <motion.header 
          initial={{ y: -20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          className="flex-none flex items-center justify-between px-4 py-3 bg-background/80 backdrop-blur-sm border-b border-border/50 z-50"
        >
          <button onClick={() => navigate('/home')} className="focus:outline-none">
            <img 
              src="/favicon.png" 
              alt="Ritual" 
              className="h-8 w-auto object-contain"
            />
          </button>
          
          <div className="flex items-center gap-3">
            <StatusIndicator />
            
            {(!couple || (couple && !couple.partner_two)) && (
              <Button 
                variant="ghost" 
                size="sm"
                onClick={() => setJoinOpen(true)}
                className="flex items-center gap-2 h-8 px-3"
              >
                <UserPlus className="w-4 h-4" />
                <span className="hidden sm:inline">Join</span>
              </Button>
            )}
          </div>
        </motion.header>
      )}

      {/* Main Content */}
      <main className="flex-1 overflow-hidden">
        {children}
      </main>

      {/* Bottom Navigation */}
      {showNav && (
        <motion.nav 
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          className="flex-none flex items-center justify-around px-4 py-3 bg-background/95 backdrop-blur-sm border-t border-border/50 z-50 pb-safe"
        >
          {navItems.map((item) => {
            const isActive = location.pathname === item.path;
            const Icon = item.icon;
            
            return (
              <button
                key={item.path}
                onClick={() => navigate(item.path)}
                className={`flex flex-col items-center gap-1 transition-colors ${
                  isActive ? 'text-primary' : 'text-muted-foreground'
                }`}
              >
                <Icon className="w-6 h-6" />
                <span className="text-xs font-medium">{item.label}</span>
              </button>
            );
          })}
        </motion.nav>
      )}

      {/* Drawers */}
      <JoinDrawer open={joinOpen} onOpenChange={setJoinOpen} />
      <CreateCoupleDialog open={createOpen} onOpenChange={setCreateOpen} />
    </div>
  );
};
```

### Task 2: Add a Database Table

**IMPORTANT:** Use Lovable Cloud UI or run a migration. Never edit types.ts directly.

**Via Migration:**
```sql
-- Create new migration file via Lovable
CREATE TABLE public.new_table (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID REFERENCES public.couples(id) NOT NULL,
  data JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Enable RLS
ALTER TABLE public.new_table ENABLE ROW LEVEL SECURITY;

-- Add policies
CREATE POLICY "Users can view their data"
  ON public.new_table FOR SELECT
  USING (EXISTS (
    SELECT 1 FROM couples 
    WHERE couples.id = new_table.couple_id
    AND (couples.partner_one = auth.uid() OR couples.partner_two = auth.uid())
  ));
```

After running migration, `types.ts` will auto-regenerate.

### Task 3: Add a shadcn/ui Component

```bash
npx shadcn-ui@latest add <component-name>
```

Example:
```bash
npx shadcn-ui@latest add dialog
```

This adds the component to `src/components/ui/`.

### Task 4: Add an Edge Function

1. **Create Function:**
```typescript
// supabase/functions/new-function/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      {
        global: {
          headers: { Authorization: req.headers.get('Authorization')! },
        },
      }
    );

    // Your logic here

    return new Response(
      JSON.stringify({ success: true }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Error:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
```

2. **Configure (if needed):**
```toml
# supabase/config.toml
[functions.new-function]
verify_jwt = true
```

3. **Deploy:**
Edge functions deploy automatically with Lovable Cloud. No manual deployment needed.

4. **Call from Frontend:**
```typescript
const response = await fetch(
  `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/new-function`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${session.access_token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ /* payload */ })
  }
);
```

### Task 5: Update Global Styles

**Design tokens are in `src/index.css`:**
```css
:root {
  --primary: 16 90% 66%;
  --primary-foreground: 0 0% 100%;
  /* ... */
}
```

**Tailwind config is in `tailwind.config.ts`:**
```typescript
export default {
  theme: {
    extend: {
      colors: {
        primary: "hsl(var(--primary))",
        /* ... */
      }
    }
  }
}
```

**IMPORTANT:** Always use semantic tokens. Never hardcode colors.

```tsx
// âŒ DON'T
<div className="text-[#FF6B6B]">

// âœ… DO
<div className="text-primary">
```

---

## Development Workflow

### Standard Workflow

1. **Pull Latest:**
```bash
git pull origin main
```

2. **Create Feature Branch:**
```bash
git checkout -b feature/my-feature
```

3. **Make Changes:**
- Edit code
- Test locally
- Check console for errors

4. **Commit:**
```bash
git add .
git commit -m "feat: add feature description"
```

5. **Push:**
```bash
git push origin feature/my-feature
```

6. **Deploy:**
Lovable Cloud auto-deploys on push to main. Merge via PR.

### Commit Message Format

Follow [Conventional Commits](https://www.conventionalcommits.org/):

- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation update
- `style:` Code style change (no logic change)
- `refactor:` Code refactoring
- `test:` Add or update tests
- `chore:` Maintenance tasks

Examples:
```
feat: add photo upload to memories
fix: resolve week boundary bug in fetchCycle
docs: update API documentation
refactor: simplify Home.tsx state logic
```

---

## Testing

### Manual Testing Checklist

Before pushing changes:

- [ ] Test happy path (main flow works)
- [ ] Test error cases (what if API fails?)
- [ ] Test loading states (show spinner)
- [ ] Test mobile responsiveness (use Chrome DevTools)
- [ ] Test realtime sync (open two browser windows)
- [ ] Test across date boundaries (change system time)
- [ ] Check console for errors
- [ ] Check network tab for failed requests

### Browser Testing

- **Primary:** Chrome Mobile (80%+ of users)
- **Secondary:** Safari iOS (20% of users)
- **Desktop:** Not priority, but should work

### Database Testing

Use Lovable Cloud UI to:
- View table data
- Run SQL queries
- Check RLS policies

Or use Supabase client:
```typescript
const { data, error } = await supabase
  .from('table_name')
  .select('*')
  .limit(10);

console.log(data);
```

---

## Debugging

### Console Logging

Add strategic console logs:
```typescript
console.log('[HOME] Current cycle:', currentCycle);
console.log('[HOME] User submitted:', userSubmitted);
```

Prefix with component name for easy filtering.

### React DevTools

Install React DevTools Chrome extension:
- Inspect component props
- View context values
- Track re-renders

### Network Tab

Check:
- API requests succeeding?
- Correct payloads sent?
- Proper authentication headers?

### Realtime Debugging

Open two browser windows side-by-side:
- Perform action in Window 1
- Watch realtime update in Window 2
- Check if state syncs correctly

### Production Debugging

If bug only happens in production:
1. Check Lovable Cloud logs
2. Check Supabase dashboard (Database â†’ Logs)
3. Check Edge Function logs
4. Ask user to provide screenshot + console logs

---

## Common Gotchas

### 1. Stale State After Navigation

**Problem:** User navigates, sees old data.

**Solution:** Add refresh in `useEffect`:
```typescript
useEffect(() => {
  if (couple?.id) {
    refreshCycle(); // Force fresh data
  }
}, []); // Run on mount
```

### 2. Race Condition with Realtime

**Problem:** Realtime fires before DB write completes.

**Solution:** Add delay after refresh:
```typescript
await refreshCycle();
await new Promise(r => setTimeout(r, 500));
// Now navigate
```

### 3. Date Boundary Bugs

**Problem:** Logic breaks at midnight or week change.

**Solution:** Don't calculate dates. Use actual data state:
```typescript
// âŒ DON'T
if (today > cycleWeekStart + 7) { /* ... */ }

// âœ… DO
if (cycle.agreement_reached) { /* ... */ }
```

### 4. JSONB Structure Changes

**Problem:** Old cycles have different synthesized_output shape.

**Solution:** Always validate:
```typescript
const rituals = Array.isArray(cycle.synthesized_output)
  ? cycle.synthesized_output
  : [];
```

### 5. Missing Null Checks

**Problem:** Crash when data unexpectedly null.

**Solution:** Add guards:
```typescript
if (!currentCycle) return null;
if (!couple?.partner_two) return <WaitingScreen />;
```

---

## Performance Tips

1. **Lazy Load Routes:** Already implemented with React Router
2. **Memoize Expensive Computations:** Use `useMemo`
3. **Debounce Input Handlers:** Use custom debounce hook
4. **Optimize Images:** Serve WebP, compress before upload
5. **Minimize Bundle Size:** Audit with `npm run build`

---

## Security Checklist

- [ ] All database queries use RLS (never disable)
- [ ] Edge functions verify JWT tokens
- [ ] User input sanitized before DB insert
- [ ] No sensitive data in console logs (production)
- [ ] Environment secrets not committed to git
- [ ] CORS headers properly configured

---

## Deployment

### Lovable Cloud (Automatic)

- **Frontend:** Deploys on push to main
- **Edge Functions:** Deploy automatically with code changes
- **Database Migrations:** Run automatically on save

### Manual Deployment (if needed)

```bash
# Build frontend
npm run build

# Deploy edge functions (if not auto-deploying)
supabase functions deploy synthesize-rituals
supabase functions deploy nudge-partner
```

---

## Monitoring

### Key Metrics to Watch

- **Error Rate:** Check Lovable Cloud logs
- **API Latency:** Monitor edge function performance
- **User Engagement:** Track weekly active couples
- **Completion Rate:** % of rituals completed

### Logging

Add structured logs to edge functions:
```typescript
console.log(JSON.stringify({
  event: 'synthesis_complete',
  coupleId,
  ritualCount: rituals.length,
  duration: Date.now() - startTime
}));
```

---

## Getting Help

### Documentation
- This guide: `/docs/HANDOFF.md`
- Architecture: `/docs/ARCHITECTURE.md`
- User Flows: `/docs/USER-FLOWS.md`
- API: `/docs/API.md`
- Database: `/docs/DATABASE.md`

### Resources
- Supabase Docs: https://supabase.com/docs
- Lovable Docs: https://docs.lovable.dev
- React Docs: https://react.dev
- Tailwind Docs: https://tailwindcss.com

### Support
- Internal Slack: #ritual-dev
- Email: dev@ritual.app
- GitHub Issues: [link]

---

## Next Steps

After reading this guide:

1. Set up local environment
2. Read ARCHITECTURE.md
3. Review USER-FLOWS.md
4. Explore codebase (start with Home.tsx)
5. Pick a "good first issue" from GitHub
6. Make your first PR!

Welcome to the team! ğŸ‰
